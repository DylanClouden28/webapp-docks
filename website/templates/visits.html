{% extends "base.html" %} 
{% block title %}Boats Visits{% endblock %} 

{% block head %}
  <link rel="stylesheet" href="static/form-styles.css">
{% endblock %}

{% block styles %}static/visit-styles.css{% endblock %}

{% block header %}{% endblock %}

{% block content%}
<style>
  .container {
      width: 100%;
      padding: 1.25em;
  }

  .boat-info-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      width: 98%;
      background: #393e46;
      padding: 1.25em;
      margin-bottom: 1.25em;
      border-radius: 5px;
      box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.1);
  }

  .boat-info-item {
      flex: 1;
      text-align: center;
      margin: 0 0.3125em;
  }

  .boat-info-item h3, h2 {
      margin: 0;
      padding-top: 0;
      padding-bottom: 0;
      font-size: 1.125em;
      color: #eeeeee;
      font-weight: normal;
  }

  header {
    display: flex;
    justify-content: flex-start;
    padding: 0;
  }

  #add-button-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
    }

  #add-button-container img {
      margin-right: 0.625em;
  }

  #table-container {
    padding-bottom: 1.25em;
    height: 15em;
    overflow-y: auto;
    background-color: #393e46;
    border-radius: 5px;
  }

  .add-visit-button {
      width: 100%;
      padding: 0.625em;
      box-sizing: border-box;
  }
  tr.add-blank-visit td{
    padding: 0.5em;
    text-align: center;
  }
  .add-blank-visit-button{
    margin-bottom: 0px;
    width: 90%;
    padding: 0.25em 0.5em;
  }

  #search-results tr.highlighted {
    background-color: #2aaeae8e
}
</style>


<div id="boat-info" class="boat-info-container">
  <a href="{{ url_for('views.log_boat', boat_reg=boat.boat_reg, boat_name=boat.boat_name, phone_number=boat.phone_number, id=boat.id) }}" id="home-btn">Back</a>
  <div class="boat-info-item"><h3><span><b>Registration:</b> </span><em>{{boat.boat_reg}}</em></h3></div>
  <div class="boat-info-item"><h3><span><b>Name:</b> </span><em>{{boat.boat_name}}</em></h3></div>
  <div class="boat-info-item"><h3><span><b>Size:</b> </span><em>{{boat.boat_size}}</em></h3></div>
  <div class="boat-info-item"><h3><span><b>Owner:</b> </span><em>{{boat.owner_name}}</em></h3></div>
  <div class="boat-info-item"><h3><span><b>Contact:</b> </span><em>{{boat.phone_number}}</em></h3></div>
</div>


<div id="main-container">
    <div id="left-container" style="flex: 1;">
            <div id="table-container">
                <table id="search-results">
                <thead>
                    <tr>
                    <th>Date in</th>
                    <th>Date Paid</th>
                    <th>Paid Days</th>
                    <th>Paid Nights</th>
                    <th>Electric / Water</th>
                    <th>Payment Method</th>
                    <th>Paid Amount</th>
                    <th>Unpaid Days</th>
                    <th>Unpaid Nights</th>
                    <th>Total</th>
                    <th>Logged By</th>
                    <th>Edit</th>
                    </tr>
                </thead>
                <tbody> 
                    <tr class="add-blank-visit" id="add-blank-visit">
                      <td colspan="12">
                          <form method="POST">
                            {{ form.hidden_tag() }}
                            <button type="submit" class="btn btn-primary add-blank-visit-button" name="submit-button" value="add_new">
                              <img src="static/more.svg" alt="Add-blank-visit" width="20" height="20"> 
                              Blank Visit
                            </button>
                          </form>
                      </td>
                    </tr>                
                    {% for visit in visits%}
                    <tr id="row-{{ visit.id }}">
                      <form class="edit-form" method="POST" action="{{ url_for('views.update_payment', visitid=visit.id, id=boat.id) }}">
                        {{ form.hidden_tag() }}
                        <td class="editable">
                          <span class="text">{{ visit.date_in | utc_to_est}}</span>
                          <input type="text" name="date_in" value="{{ visit.date_in | utc_to_est}}">
                        </td>
                        <td class="editable">
                          <span class="text">{{ visit.date_paid | utc_to_est}}</span>
                          <input type="text" name="date_paid" value="{{ visit.date_paid | utc_to_est}}">
                        </td>
                        <td class="editable">
                          <span class="text">{{ visit.paid_days }}</span> 
                          <input type="text" name="paid_days" value="{{ visit.paid_days }}">
                          </td>
                        <td class="editable">
                          <span class="text">{{ visit.paid_nights }}</span>
                          <input type="text" name="paid_nights" value="{{ visit.paid_nights }}">
                          </td>
                        <td class="editable">
                          <span class="text">{{ visit.paid_enw }}</span>
                          <div class="radio-group" style="display: none;">
                              <input type="radio" name="paid_enw" value="Yes" {% if visit.paid_enw == True %}checked{% endif %}> Yes
                              <input type="radio" name="paid_enw" value="No" {% if visit.paid_enw == False %}checked{% endif %}> No
                          </div>
                          </td>
                        <td class="editable">
                          <span class="text">{{ visit.paid_with }}</span>
                          <div class="radio-group" style="display: none;">
                              <input type="radio" name="paid_with" value="Cash" {% if visit.paid_with == 'Cash' %}checked{% endif %}> Cash
                              <input type="radio" name="paid_with" value="Check" {% if visit.paid_with == 'Check' %}checked{% endif %}> Check
                              <input type="radio" name="paid_with" value="Charge" {% if visit.paid_with == 'Charge' %}checked{% endif %}> Charge
                          </div>           
                          </td>
                          <td>${{ visit.paid_amount }}0</td>
                          <td>{{ visit.unpaid_days  }}</td>
                          <td>{{ visit.unpaid_nights }}</td>
                          <td>${{ visit.total }}0</td>
                          <td>
                            {% if visit.logged_by == None %}
                                None
                            {% else %}
                                {{ visit.logged_by|userID_to_name }}
                            {% endif %}
                          </td>
                          <td>
                            <button type="button" class="edit-button">
                              <img src="static/edit.svg" alt="Edit" width="20" height="20">
                            </button>                          
                            <button type="submit" class="save-button" style="display: none;">
                              <img src="static/check.svg" alt="Save" width="20" height="20">
                            </button>
                            <button type="button" class="cancel-button" style="display: none;">
                              <img src="static/cancel.svg" alt="Cancel" width="20" height="20">
                            </button>
                          </td>
                      </form>
                    </tr>
                    {% endfor %}
                </tbody>
                </table>
            </div>
            </div>
    </div>


    <div id="right-container" style="flex: 1;">
        <div id="search-container">
          <form method="POST" id="search">
            {{ form.hidden_tag() }}
            <div class="form-group">
              {{ form.paid_days.label }}
              {{ form.paid_days(class="form-control") }}
            </div>
            <div class="form-group">
              {{ form.paid_nights.label }}
              {{ form.paid_nights(class="form-control") }}
            </div>
            <div>
              <h3 class="form-check-input">Using Water or Electric</h3>
                {% for subfield in form.paid_enw %}
                    {{ subfield(class="form-check-input") }} {{ subfield.label(class="form-check-label") }}
                {% endfor %}
            </div>  
            <div>
              <h3 class="form-check-input">Payment Method</h3> 
                {% for subfield in form.paid_with %}
                    {{ subfield(class="form-check-input") }} {{ subfield.label(class="form-check-label") }}
                {% endfor %}
            </div>
            <div id="button-container">
              <div id="button-container">
                <button type="submit" class="btn btn-primary" id="login-btn" name="submit-button" value="search">
                  <div id="add-button-container">
                    <img src="static/more.svg" alt="Add-visit" width="20" height="20"> 
                    Payment
                  </div>
                </button>
              </div>
            </div>
          </form>
        </div>
</div>

<script>
  var editButtons = document.getElementsByClassName("edit-button");
  var addVisitForm = document.getElementById("add-visit");
  
  // Add click event listener to all edit buttons
  for (var i = 0; i < editButtons.length; i++) {
      editButtons[i].addEventListener("click", function() {
          var row = this.parentElement.parentElement;
          var form = row.getElementsByClassName("edit-form")[0];
          var editables = row.getElementsByClassName("editable");
  
          form.style.display = 'block';
          this.style.display = 'none';
          row.getElementsByClassName("cancel-button")[0].style.display = 'block';
          row.getElementsByClassName("save-button")[0].style.display = 'block'; 
          
          // Loop through editable cells
          for (var j = 0; j < editables.length; j++) {
              var inputs = editables[j].getElementsByTagName('input');
              var radioGroups = editables[j].getElementsByClassName('radio-group');
              for (var k = 0; k < inputs.length; k++) {
                  inputs[k].style.display = 'inline';
              }
              for (var k = 0; k < radioGroups.length; k++) {
                  radioGroups[k].style.display = 'inline';
              }
              var text = editables[j].getElementsByClassName('text')[0];
              text.style.display = 'none';
          }
      });
  }
  
  // Add click event listener to all cancel buttons
  var cancelButtons = document.getElementsByClassName("cancel-button");
  for (var i = 0; i < cancelButtons.length; i++) {
      cancelButtons[i].addEventListener("click", function() {
          var row = this.parentElement.parentElement;
          var form = row.getElementsByClassName("edit-form")[0];
          var editables = row.getElementsByClassName("editable");
          
          form.style.display = 'none';
          this.style.display = 'none';
          row.getElementsByClassName("edit-button")[0].style.display = 'block';
          row.getElementsByClassName("save-button")[0].style.display = 'none';
          
          // Loop through editable cells
          for (var j = 0; j < editables.length; j++) {
              var inputs = editables[j].getElementsByTagName('input');
              var radioGroups = editables[j].getElementsByClassName('radio-group');
              for (var k = 0; k < inputs.length; k++) {
                  inputs[k].style.display = 'none';
              }
              for (var k = 0; k < radioGroups.length; k++) {
                  radioGroups[k].style.display = 'none';
              }
              var text = editables[j].getElementsByClassName('text')[0];
              text.style.display = 'inline';
          }
      });
  }
  
  // On page load, hide all input fields in editable cells
  window.onload = function() {
      var editables = document.getElementsByClassName("editable");
      for (var i = 0; i < editables.length; i++) {
          var inputs = editables[i].getElementsByTagName('input');
          var radioGroups = editables[i].getElementsByClassName('radio-group');
          for (var j = 0; j < inputs.length; j++) {
              inputs[j].style.display = 'none';
          }
          for (var j = 0; j < radioGroups.length; j++) {
              radioGroups[j].style.display = 'none';
          }
      }
  }
  

</script>


<script>
  //Code for adding highlights to rows
  document.addEventListener("DOMContentLoaded", function() {
    const tableBody = document.querySelector("#search-results tbody");
    const submitButton = document.getElementById("login-btn");
    const searchForm = document.getElementById("search");
    const selectedRowIdInput = searchForm.querySelector("#selectedRowId");
    let selectedRow = null;

    tableBody.addEventListener("click", function(event) {
        // Get the closest tr element
        const clickedRow = event.target.closest("tr");

        // If no tr was found or the tr is the add-blank-visit, return
        if (!clickedRow || clickedRow.classList.contains("add-blank-visit")) return;

        // If a row was previously selected, remove its highlight
        if (selectedRow) {
            selectedRow.classList.remove("highlighted");
        }

        // Highlight the clicked row
        clickedRow.classList.add("highlighted");
        selectedRow = clickedRow;

        // Extract ID from the row's ID attribute and set it to the hidden input
        const rowId = clickedRow.id.replace('row-', '');
        console.log("Setting hidden input to: " + rowId);
        selectedRowIdInput.value = rowId;

        // Enable the submit button
        submitButton.disabled = false;
    });

    // Initially disable the submit button
    submitButton.disabled = true;
});



</script>


{%endblock%}